<?php
/*
 * Gallery - a web based photo album viewer and editor
 * Copyright (C) 2000-2007 Bharat Mediratta
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or (at
 * your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA  02110-1301, USA.
 */

/**
 * @package Userinfo
 * @subpackage UserInterface
 * @author Charles Knowlton charles2007@users.sourceforge.net
 * @version $Revision$
 */



/**
 * Handle input from our sample page
 *
 * @package Userinfo
 * @subpackage UserInterface
 *
 */
class UserinfoController extends GalleryController {

    function handleRequest($form) {
	global $gallery;

	}

}


/**
 * This is a sample page generated by the Gallery 2 module creator.
 *
 * @package Userinfo
 * @subpackage UserInterface
 *
 */
class UserinfoView extends GalleryView {

    /**
     * @see GalleryView::loadTemplate
     */
    function loadTemplate(&$template, &$form) {
	GalleryCoreApi::requireOnce('modules/userinfo/functions.inc');

	$tableName3 = "UserinfoSetupMap";
	$select3 = array('uiPerPage', 'uiDefaultSortColumn', 'uiDefaultSortOrder', 'uiDateFormat');
	list ($ret, $searchResults3) = GalleryCoreApi::getMapEntry($tableName3, $select3);
		while ($result3 = $searchResults3->nextResult())
		{
			$data['result'] = array('uiPerPage' => $result3[0], 'uiDefaultSortColumn' => $result3[1], 'uiDefaultSortOrder' => $result3[2], 'uiDateFormat' => $result3[3]);
		}

	$count = $data['result']['uiPerPage']; //# to display per page
	$offset = "0";

	if (isset($_GET['g2_page']) && ($_GET['g2_page'] == "1" || $_GET['g2_page'] == "")) {
		$offset = "0";
	} else {
		if (isset($_GET['g2_page']) && $_GET['g2_page'] > "1") {
			$offset = $_GET['g2_page'] * $count - $count;
		}
	}

	/* Find out sort column and sort order */
	/* If not set use defaults             */
	if (isset($_GET['g2_order']) && $_GET['g2_order'] == "DES") {
		if (isset($_GET['g2_sort']) && ($_GET['g2_sort'] == 'id' || $_GET['g2_sort'] == 'userId' || $_GET['g2_sort'] == 'userName' || $_GET['g2_sort'] == 'ipAddress' || $_GET['g2_sort'] == 'timeStamp' || $_GET['g2_sort'] == "action")) {
			$column = $_GET['g2_sort'];			
		} else {
			$column = $data['result']['uiDefaultSortColumn'];			
		}
		$optional = array('limit' => array('count' => $count, 'offset' => $offset), 'orderBy' => array($column => ORDER_DESCENDING) );
	} else if (isset($_GET['g2_order']) && $_GET['g2_order'] == "ASC") {
		if (isset($_GET['g2_sort']) && ($_GET['g2_sort'] == 'id' || $_GET['g2_sort'] == 'userId' || $_GET['g2_sort'] == 'userName' || $_GET['g2_sort'] == 'ipAddress' || $_GET['g2_sort'] == 'timeStamp' || $_GET['g2_sort'] == "action")) {
			$column = $_GET['g2_sort'];			
		} else {
			$column = $data['result']['uiDefaultSortColumn'];			
		}
		$optional = array('limit' => array('count' => $count, 'offset' => $offset), 'orderBy' => array($column => ORDER_ASCENDING) );
	} else {
		/* Use Defaults */	
		$column = $data['result']['uiDefaultSortColumn'];
		if ($data['result']['uiDefaultSortOrder'] == "DES") {
			$optional = array('limit' => array('count' => $count, 'offset' => $offset), 'orderBy' => array($column => ORDER_DESCENDING) );
		} else {
			$optional = array('limit' => array('count' => $count, 'offset' => $offset), 'orderBy' => array($column => ORDER_ASCENDING) );
		}	
	}

	$tableName = "UserinfoMap";
	$select = array('id', 'userId', 'userName', 'ipAddress', 'timeStamp', 'action');
	$match = array();


	$Userinfo['data'] = array();
	list ($ret, $searchResults) = GalleryCoreApi::getMapEntry($tableName, $select, $match, $optional);
		while ($result = $searchResults->nextResult())
		{
			$Userinfo['data'][] = array('id' => $result[0], 'userId' => $result[1], 'userName' => $result[2], 'ipAddress' => $result[3], 'timeStamp' => $result[4], 'action' => $result[5]);
		}


	/* Queries the table to get # of rows */
	list ($ret, $searchResults2) = GalleryCoreApi::getMapEntry($tableName, array('id'));
		while ($result2 = $searchResults2->nextResult())
		{
			$numRows[] = array('id' => $result2[0]);
		}
	/* Counting # of records in the array */
	$rowsCount = count($numRows);
	/* Setting the # of records into an array for the .tpl page */
	$Userinfo['numRowsCount'] = $rowsCount;

	$Userinfo['uiDateFormat'] = $data['result']['uiDateFormat'];


	$myView = "core.SiteAdmin";
	$mySubView = "userinfo.Userinfo";
	$myTotalRecords = $rowsCount;

	$pagination = numPages($myView, $mySubView, $count, $myTotalRecords);

	$template->setVariable('pagination', $pagination);
	$template->setVariable('controller', 'userinfo.Userinfo');
	$template->setVariable('Userinfo', $Userinfo);
 
	return array(null, array('body' => 'modules/userinfo/templates/Userinfo.tpl'));
		
    }

}

?>